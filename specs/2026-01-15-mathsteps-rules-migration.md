# Миграция правил в MathStepsEngine и корректное добавление +0

## 0. Метаданные
- Тип (профиль): Архитектурный рефакторинг (refactor-architecture)
- Владелец: команда MathHelper
- Масштаб: large
- Целевой релиз / ветка: текущая ветка
- Ограничения: не писать код до утверждения спеки; не удалять файлы без явного подтверждения; использовать существующие файлы проекта; без создания новых файлов, кроме спеки и тестов в существующих каталогах; комментарии и документация на русском
- Связанные ссылки: specs/2026-01-16-operations-availability.md

## 1. Overview / Цель
1) Исправить формат операции "Добавить +0": превью и результат должны быть вида `(x + 0)`, а не `(x) + 0`.
2) Перенести все операции из `src/core/rules.ts` в `MathStepsEngine` и удалить `src/core/rules.ts`.
3) Обновить зависимости (анализатор/тесты) на новый источник операций.
4) Найти неиспользуемые TS/JS модули по факту использования (учитывая runtime и скрипты) и удалить их **только после подтверждения пользователя для каждого файла**.

## 2. Текущее состояние (AS-IS)
- UI работает через `MathStepsEngine` и mathsteps AST.
- `src/core/rules.ts` содержит отдельный набор правил для внутреннего AST (ExpressionParser) и используется `src/core/analyzer.ts` и тестами.
- `MathStepsEngine` уже содержит часть кастомных операций (коммутативность, скобки, +0, *1 и т.д.), но не покрывает весь набор правил из `rules.ts`.
- Операция "+0" в `MathStepsEngine` формирует строку `(${expr}) + 0`, что дает превью `(x) + 0` вместо `(x + 0)`.
- В проекте есть TS/JS модули, которые могут быть неиспользуемыми по факту (нужно подтвердить).

## 3. Проблема
- Неверный формат превью и результата для операции "+0".
- Дублирование и расхождение правил между `rules.ts` и `MathStepsEngine`.
- Наличие потенциально неиспользуемых модулей без явного контроля.

## 4. Цели дизайна
- Единственный источник операций: `MathStepsEngine`.
- Полный паритет операций с `rules.ts`.
- Корректный формат `(expr + 0)` всегда, независимо от простоты выражения.
- Прозрачный контроль удаления модулей: список кандидатов + подтверждение пользователя на удаление каждого файла.
- Минимальный риск регрессий: полные unit-тесты и обновление E2E при необходимости.

## 5. Non-Goals (чего НЕ делаем)
- Не меняем mathsteps библиотеку.
- Не меняем структуру UI и верстку.
- Не удаляем файлы, кроме подтвержденных TS/JS модулей.
- Не добавляем новые файлы вне текущих тестовых/спек-каталогов.

## 6. Предлагаемое решение (TO-BE)

### 6.1 Распределение ответственности
| Компонент | Ответственность до | Ответственность после |
| --- | --- | --- |
| `MathStepsEngine` | mathsteps + часть кастомных операций | Единый источник операций, полный набор правил из `rules.ts` |
| `rules.ts` | Генерация правил для AST `ExpressionParser` | Удален |
| `analyzer.ts` | Работает на AST `ExpressionParser` и `rules.ts` | Использует `MathStepsEngine`/mathsteps AST для операций |
| UI (`ExpressionEditorApp`, `CommandPanel`) | Потребляет список операций | Без изменений |

### 6.2 Схема зависимостей (ASCII)
До:
```
ExpressionEditorApp -> MathStepsEngine -> mathsteps
Analyzer -> ExpressionParser -> rules.ts
Tests -> rules.ts / analyzer.ts / parser.ts
```

После:
```
ExpressionEditorApp -> MathStepsEngine -> mathsteps
Analyzer -> MathStepsEngine
Tests -> MathStepsEngine / analyzer.ts (обновленные)
```

### 6.3 Публичные API (после)
- `MathStepsEngine.listOps(expression, selectionPath)` — возвращает все операции (mathsteps + кастомные из rules).
- `MathStepsEngine.apply(expression, selectionPath, operationId)` — применяет операции, включая новые кастомные.
- `extractNodesFromMathStepsAst(rootNode, exprString)` — остается без изменений.
- `extractNodesFromAST` и `findAllSubexpressions` — будут либо удалены, либо переориентированы на `MathStepsEngine` (см. план).

### 6.4 Детальный дизайн
1) Исправление "+0":
   - В `MathStepsEngine` изменить формирование узла для `ADD_ADDING_ZERO` на `(${nodeText} + 0)` (и в превью, и при применении).
   - Гарантировать, что скобки всегда включают сумму.

2) Миграция правил из `rules.ts`:
   - Провести инвентаризацию всех `id` из `rules.ts`.
   - Сопоставить их с существующими `changeType` и кастомными операциями `MathStepsEngine`.
   - Для отсутствующих — реализовать кастомные операции в `MathStepsEngine` на mathsteps AST.
   - Обновить `CHANGE_TYPE_CATEGORY`, `CHANGE_TYPE_ORDER`, `CHANGE_TYPE_DESCRIPTION` для новых `changeType`.
   - Обеспечить превью и применение операций через `listOps` и `applyCustomOperation`.

3) Анализатор:
   - Перевести использование правил на `MathStepsEngine.listOps` или на mathsteps AST, чтобы не зависеть от `rules.ts`.
   - Удалить/обновить функции, которые привязаны к `ExpressionParser` и `rules.ts`.

4) Удаление `rules.ts`:
   - После миграции обновить импорты и удалить файл.

5) Неиспользуемые TS/JS модули:
   - Провести статический анализ импортов с учетом entrypoints:
     - `expression-editor-modular.html` (main UI entry)
     - `package.json` scripts (тесты, e2e)
     - `vite.config.ts` (build entry)
     - `playwright.config.ts` и `e2e/*.spec.ts`
   - Сформировать список кандидатов и **запросить подтверждение удаления для каждого файла**.

## 7. Бизнес-правила / Алгоритмы
Переносимые правила (по `rules.ts`):
- Вычисления: `eval_mul_*`, `eval_div`, `eval_add_*`
- Упрощения: `remove_mult_one`, `simplify_mult_zero`, `remove_div_one`, `remove_add_zero`
- Скобки/унарные: `double_negation`, `remove_parens`, `remove_double_parens`, `remove_unary_parens`
- Ассоциативность: `assoc_flatten_add`, `assoc_flatten_mul`
- Дистрибутивность: `distributive_forward`, `distributive_forward_left`
- Факторизация: `factor_common_left_all`, `factor_common_right_all`
- Преобразования знаков: `sum_to_sub_*`, `sub_to_sum_*`, `distribute_unary_minus`, `factor_unary_minus`
- Перенос минуса: `pull_unary_minus_mul_*`, `remove_double_neg_div`, `pull_unary_minus_div_left`, `pull_unary_minus_div_right`
- Деление/умножение: `div_to_mul_inverse`
- Коммутативность: `commutative_add`, `commutative_mul`
- Нотация: `expand_implicit_mul`, `collapse_to_implicit_mul`
- Обертка: `add_parens`, `add_double_neg`, `multiply_by_one`, `divide_by_one`, `add_zero`

## 8. Точки интеграции и триггеры
- `MathStepsEngine.listOps` — включает все операции (mathsteps + новые кастомные).
- `MathStepsEngine.apply` — корректно применяет новые changeType.
- `CommandPanel` — потребляет список операций без изменений.

## 9. Изменения модели данных
- Расширение `changeType` и описание для операций, перенесенных из `rules.ts`.
- Возможные обновления `MathStepsOperation` в части `description/preview/category/order`.

## 10. Миграция / Rollout / Rollback
- Rollout: перенос правил в `MathStepsEngine`, обновление анализатора/тестов, удаление `rules.ts`.
- Rollback: вернуть `rules.ts` и старые импорты, откатить кастомные операции (последний коммит).

## 11. Тестирование и критерии приемки
Acceptance Criteria:
- Операция "+0" дает `(x + 0)` в превью и после применения.
- Все правила из `rules.ts` доступны через `MathStepsEngine.listOps` и применяются корректно.
- `rules.ts` удален, проект собирается и тесты проходят.
- Сформирован список неиспользуемых TS/JS модулей, удалены только подтвержденные пользователем.

Unit-тесты (существующие файлы):
- `src/test/mathstepsEngine.test.ts`: добавить тест на `(x + 0)` (превью и применение), и на ключевые правила, перенесенные из `rules.ts`.
- `src/test/analyzer.test.ts`: обновить под новый источник операций или удалить тесты, если функциональность удаляется.
- `src/test/rules.test.ts`: заменить на тесты `MathStepsEngine` или удалить файл после переноса.

E2E:
- Запускать `npm run test:e2e:with-dev` только если меняется UI или поведение команд в интерфейсе.

Команды:
```
npm run test:run
npm run coverage
npm run build
```

## 12. Риски и edge cases
- Некоторые правила `rules.ts` могут не иметь прямого соответствия в mathsteps AST — нужен аккуратный маппинг.
- Удаление `ExpressionParser`/`analyzer` может сломать тесты — требуется обновление тестов и зависимостей.
- Возможны ложноположительные кандидаты на удаление модулей — требуется подтверждение пользователя.

## 13. План выполнения
1) Провести инвентаризацию правил `rules.ts` и сопоставление с `MathStepsEngine`.
2) Обновить `MathStepsEngine` для полного набора правил, включая корректный `(expr + 0)`.
3) Перевести `analyzer.ts` на `MathStepsEngine` или удалить его части при необходимости.
4) Обновить тесты (mathstepsEngine/analyzer/rules).
5) Провести анализ неиспользуемых модулей и запросить подтверждение на удаление каждого файла.
6) Удалить подтвержденные файлы и прогнать тесты.

## 14. Открытые вопросы
- Нет (разрешен эквивалентный формат `id` и `preview`).

## 15. Результат прогона линтера
- [PASS] 1. Есть чёткая цель.
- [PASS] 2. Описано текущее состояние (AS-IS).
- [PASS] 3. Сформулирована одна проблема.
- [PASS] 4. Цели дизайна ограничивают решение.
- [PASS] 5. Non-Goals заданы явно.
- [PASS] 6. Есть распределение ответственности.
- [PASS] 7. Явно указаны точки интеграции.
- [PASS] 8. Бизнес-логика формализована.
- [PASS] 9. Описана обработка ошибок.
- [PASS] 10. Учтена производительность (явных требований нет).
- [PASS] 11. Описаны изменения модели данных.
- [PASS] 12. Есть план миграции.
- [PASS] 13. Учтена обратная совместимость / откат.
- [PASS] 14. Есть измеримые критерии приёмки.
- [PASS] 15. Есть план тестирования.
- [PASS] 16. Есть команды для проверки.
- [PASS] 17. Есть пошаговый план.
- [PASS] 18. Нет блокирующих открытых вопросов.
- [PASS] 19. Масштаб задачи соответствует глубине спеки.
- [PASS] 20. Выполнены требования выбранного профиля.

## Approval
Ожидается фраза: "Спеку подтверждаю"
