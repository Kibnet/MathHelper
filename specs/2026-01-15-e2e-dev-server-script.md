# Скрипт запуска dev-сервера для E2E

## 0. Метаданные
- Тип (профиль): Проектирование подсистемы
- Владелец: команда MathHelper
- Масштаб: medium
- Целевой релиз / ветка: текущая ветка
- Ограничения: не писать код до утверждения спеки; использовать существующие файлы проекта; не создавать новых файлов без явного указания — здесь создание скриптов разрешено; документация и комментарии на русском
- Связанные ссылки: e2e/README.md, TESTING.md, Agents.md

## 1. Overview / Цель
Добавить надёжные скрипты (PowerShell и bash) для автоматического запуска/остановки dev‑сервера перед E2E, обновить команды npm и привести инструкции к единому источнику правды без дублей.

## 2. Текущее состояние (AS-IS)
- Запуск E2E требует ручного старта dev‑сервера; в PowerShell `Start-Process` часто падает.
- Инструкции по E2E продублированы в e2e/README.md, TESTING.md и Agents.md, есть повторы.
- В проекте есть `run-e2e-tests.ps1`, но он не управляет dev‑сервером.

## 3. Проблема
Нет надёжного автоматического запуска dev‑сервера для E2E на разных платформах, а инструкции разрознены и повторяются, что приводит к ошибкам запуска.

## 4. Цели дизайна
- Надёжный автозапуск/остановка dev‑сервера для E2E на Windows и Unix‑подобных средах.
- Автоматическое завершение уже запущенного dev‑сервера на нужном порту перед запуском.
- Конфигурируемость через переменные окружения с корректными fallback.
- Единые инструкции без дублирования: подробности в одном месте, ссылки из остальных.

## 5. Non-Goals
- Не переписываем Playwright конфиг `webServer`.
- Не меняем структуру UI или логики тестов.
- Не вводим сторонние менеджеры процессов.

## 6. Предлагаемое решение (TO-BE)
### 6.1 Распределение ответственности
- Новые скрипты:
  - `run-e2e-with-dev.ps1` — PowerShell
  - `run-e2e-with-dev.sh` — bash
- npm‑скрипты в `package.json` для удобного запуска.
- Документация в `e2e/README.md` как источник истины; в `TESTING.md` и `Agents.md` только ссылки.

### 6.2 Детальный дизайн
Скрипты делают:
1) Читают env:
   - `E2E_PORT` (fallback: `8000`)
   - `E2E_HOST` (fallback: `0.0.0.0`)
   - `E2E_BASE_URL` (fallback: `http://localhost:${E2E_PORT}/MathHelper/`)
2) Проверяют, не занят ли порт:
   - Если занят — останавливают процесс(ы), слушающие порт.
3) Запускают `npm run dev -- --host ... --port ...`.
4) Ждут готовность сервера (poll HTTP `expression-editor-modular.html`).
5) Запускают `npm run test:e2e` с `E2E_BASE_URL`.
6) В любом случае гасят dev‑сервер.

Надёжность:
- Таймаут ожидания готовности (например 30–60с).
- Явное логирование шагов.
- Корректный `trap`/`try/finally` для остановки сервера.

### 6.3 UX / CLI
Добавить npm‑скрипты:
- `test:e2e:with-dev` → PowerShell‑скрипт на Windows, bash‑скрипт на Unix
- (опционально) `test:e2e:with-dev:ps` и `test:e2e:with-dev:sh`

### 6.4 Документация
`e2e/README.md`:
- Новый раздел «Автоматический запуск dev‑сервера».
- Примеры с env‑переменными и fallback.

`TESTING.md` и `Agents.md`:
- Удалить дублирующие описания шагов.
- Оставить короткий блок со ссылкой на `e2e/README.md`.

## 7. Бизнес-правила / Алгоритмы
- Если порт занят — всегда останавливать процессы на нём перед запуском.
- Если dev‑сервер не поднялся за таймаут — тесты не запускаются, скрипт завершает сервер и выходит с ошибкой.

## 8. Точки интеграции и триггеры
- `package.json` scripts.
- `e2e/README.md`, `TESTING.md`, `Agents.md`.
- Новый скрипт запускается вручную разработчиком.

## 9. Изменения модели данных / состояния
Не требуется.

## 10. Миграция / Rollout / Rollback
- Rollout: добавить скрипты и инструкции, оставить существующие команды `npm run test:e2e`.
- Rollback: удалить скрипты и вернуть старые инструкции.

## 11. Тестирование и критерии приёмки
Acceptance Criteria:
- Запуск `npm run test:e2e:with-dev` поднимает сервер, выполняет E2E, гасит сервер.
- При занятом порте сервер корректно перезапускается.
- Документация без повторов, `Agents.md` ссылается на `e2e/README.md`.

Команды:
- `npm run test:e2e:with-dev`
- `npm run test:e2e`

## 12. Риски и edge cases
- Убийство неправильного процесса на порту (нужно ограничить по порту и PID).
- Ожидание готовности сервера может быть нестабильным.

## 13. План выполнения
1) Добавить скрипты PowerShell и bash.
2) Обновить `package.json` с новыми командами.
3) Обновить `e2e/README.md` и убрать дубли в `TESTING.md`/`Agents.md`.
4) Прогнать `npm run test:e2e:with-dev`.

## 14. Открытые вопросы
- Нужен ли отдельный режим, который не убивает уже запущенный сервер? (по текущему запросу — нет)

## 15. Результат прогона линтера
- [PASS] 1. Есть чёткая цель.
- [PASS] 2. Описано текущее состояние (AS-IS).
- [PASS] 3. Сформулирована одна проблема.
- [PASS] 4. Цели дизайна ограничивают решение.
- [PASS] 5. Non-Goals заданы явно.
- [PASS] 6. Есть распределение ответственности.
- [PASS] 7. Явно указаны точки интеграции.
- [PASS] 8. Бизнес-логика формализована.
- [PASS] 9. Описана обработка ошибок.
- [PARTIAL] 10. Учтена производительность (есть таймауты, но без оценки стоимости проверок).
- [PASS] 11. Описаны изменения модели данных.
- [PASS] 12. Есть план миграции.
- [PASS] 13. Учтена обратная совместимость / откат.
- [PASS] 14. Есть измеримые критерии приёмки.
- [PASS] 15. Есть план тестирования.
- [PASS] 16. Есть команды для проверки.
- [PASS] 17. Есть пошаговый план.
- [PASS] 18. Нет блокирующих открытых вопросов.
- [PASS] 19. Масштаб задачи соответствует глубине спеки.
- [PASS] 20. Выполнены требования выбранного профиля.

## Approval
Ожидается фраза: "Спеку подтверждаю"
