# Правила взаимодействия с агентом

## Языковые предпочтения

1. Все общение должно вестись на русском языке
2. Вся документация, комментарии и пояснения должны быть на русском языке
3. Технические термины могут сохраняться в оригинальном виде (например, "TypeScript", "HTML")

## Основные принципы работы

1. При решении задач необходимо:
   - Подробно объяснять каждый шаг
   - Предоставлять контекст и причины принимаемых решений
   - Предложить несколько вариантов решения, обосновать сильные и слабые стороны каждого и дождаться явного выбора от пользователя
   - Проверять работу кода перед завершением задачи

2. При работе с кодом:
   - Использовать только существующие файлы проекта
   - Не создавать новые файлы без явного указания
   - Сохранять структуру и стиль кода проекта

3. При создании или изменении файлов:
   - Все комментарии должны быть на русском языке
   - Названия переменных и функций могут оставаться на английском
   - Документация к функциям и классам должна быть на русском

## Development process

All tasks MUST follow Quest Mode:

1. Clarification
2. Specification
3. Explicit approval
4. Implementation
5. Tests and report

No code before specification approval.

Violation of this process is considered an error.

## Стиль общения

1. Отвечать четко и по делу
2. Избегать излишне формального тона
3. Объяснять технические моменты доступным языком
4. Предлагать альтернативные решения при необходимости

## Работа с ошибками

1. При обнаружении ошибок:
   - Подробно описать проблему
   - Предложить несколько вариантов решения
   - Объяснить последствия каждого варианта
   - Написать тест для воспроизведния перед исправленим чтобы проверить что ошибка ушла и чтобы её возвращение в будущем фиксировалось падением теста
   - Запускать тесты и исправлять пока тест не будет проходить

2. При тестировании:
   - Проверять работоспособность внесенных изменений
   - Если тест упал, нужно определить, это проблема в тесте или в логике. Если вероятно и то и другое спросить у меня, чтобы я принял решение
   - Указывать, как протестировать функциональность

## Автоматическое тестирование

### Обязательное покрытие тестами

**КРИТИЧЕСКИ ВАЖНО:** Любые изменения в коде ДОЛЖНЫ сопровождаться автоматическими тестами.

### 1. При добавлении новых функций

**Обязательно:**
- Написать unit-тесты для всех новых функций и методов
- Покрыть все ветки логики (if/else, switch, циклы)
- Протестировать граничные случаи и edge cases
- Написать E2E тест если функция влияет на UI

**Порядок действий:**
1. Реализовать функцию
2. Написать тесты, покрывающие:
   - Успешные сценарии (happy path)
   - Граничные значения (пустые строки, null, undefined, 0, отрицательные числа)
   - Ошибочные входные данные
   - Edge cases специфичные для функции
3. Запустить тесты: `npm test`
4. Убедиться что все тесты проходят
5. Если тесты для UI - дополнительно запустить E2E: `npm run test:e2e`

**Пример:** При добавлении новой функции парсинга:
```typescript
// src/utils/newParser.ts - новая функция
export function parseExpression(input: string): AST { ... }

// src/test/newParser.test.ts - обязательные тесты
describe('parseExpression', () => {
  test('парсит простое выражение', () => { ... });
  test('обрабатывает пустую строку', () => { ... });
  test('выбрасывает ошибку при невалидном вводе', () => { ... });
  test('корректно обрабатывает вложенные скобки', () => { ... });
});
```

### 2. При исправлении багов

**ОБЯЗАТЕЛЬНЫЙ алгоритм TDD (Test-Driven Debug):**

1. **Написать failing тест** - создать тест, воспроизводящий баг
   ```typescript
   test('баг: деление на ноль должно выбрасывать ошибку', () => {
     expect(() => divide(5, 0)).toThrow('Division by zero');
   });
   ```

2. **Запустить тест** - убедиться что тест падает (воспроизводит баг)
   ```bash
   npm test -- divide.test.ts
   ```

3. **Исправить код** - внести минимальные изменения для исправления

4. **Запустить тест снова** - убедиться что тест теперь проходит

5. **Запустить все тесты** - проверить что исправление не сломало другую функциональность
   ```bash
   npm test
   ```

**Важно:** Тест должен остаться в кодовой базе как regression test, чтобы предотвратить возврат бага.

### 3. При изменении существующей функциональности

**Обязательно:**
- Обновить существующие тесты если меняется поведение
- Добавить новые тесты для нового поведения
- Запустить все тесты перед и после изменений
- Убедиться что coverage не упал

**Порядок действий:**
1. Запустить существующие тесты: `npm test`
2. Внести изменения в код
3. Обновить/добавить тесты
4. Запустить тесты снова
5. Проверить coverage: `npm run coverage`
6. Если coverage упал - добавить недостающие тесты

### 4. Типы тестов в проекте

#### Unit-тесты (Vitest)
**Где:** `src/test/*.test.ts`
**Когда использовать:**
- Тестирование отдельных функций и модулей
- Проверка логики парсера, анализатора, правил трансформации
- Тестирование утилит и хелперов
- Изолированное тестирование без UI

**Команды:**
```bash
npm test              # Запуск в watch режиме
npm run test:run      # Однократный запуск
npm run test:ui       # UI для тестов
npm run coverage      # С отчетом покрытия
```

**Стандарты:**
- Минимум 80% покрытие кода
- Все публичные функции должны быть покрыты
- Тесты должны быть независимыми друг от друга
- Использовать describe/test для структурирования

#### E2E тесты (Playwright)
**Где:** `e2e/*.spec.ts`
**Когда использовать:**
- Тестирование пользовательских сценариев
- Проверка UI взаимодействий
- Интеграционное тестирование фронтенда
- Проверка консольных логов браузера

**Критически важно:** E2E тесты требуют запущенного dev сервера!

**Команды:**
```bash
# Шаг 1: Запустить dev сервер (в первом терминале)
npm run dev -- --host 0.0.0.0 --port 8000
# Дождаться: ✓ VITE ready... ➜ Local: http://localhost:8000/

# Шаг 2: Запустить тесты (во втором терминале)
npm run test:e2e         # Headless режим
npm run test:e2e:headed  # С видимым браузером
npm run test:e2e:ui      # Интерактивный режим
npm run test:e2e:debug   # Режим отладки
```

**Переменная окружения для baseURL (рекомендуется при нестандартном base path):**
```bash
# По умолчанию baseURL = http://localhost:8000/MathHelper/
# Можно переопределить для другой базы:
E2E_BASE_URL="http://localhost:8000/MathHelper/" npm run test:e2e
```

**PowerShell:** Для корректного вывода используйте:
```bash
$env:FORCE_COLOR=1; npx playwright test --reporter=list
# Или:
.\run-e2e-tests.ps1
```

**Типичные проблемы:**
- `ERR_CONNECTION_REFUSED` → Запустите `npm run dev`
- Нет вывода в PowerShell → Используйте `$env:FORCE_COLOR=1`
- Элементы не найдены → Проверьте селекторы (#expressionInput, #commandsPanel, #expressionContainer)
- Ошибка toHaveTitle → Используйте "Преобразователь выражений"

**Когда писать E2E тесты:**
- Добавлена новая UI функциональность
- Изменен пользовательский интерфейс
- Нужно проверить взаимодействие компонентов
- Проверка работы в реальном браузере

**Отладка падающих E2E тестов:**
1. Запустить с видимым браузером: `npm run test:e2e:headed`
2. Использовать режим отладки: `npm run test:e2e:debug`
3. Проверить скриншоты в `test-results/`
4. Просмотреть логи в `test-output.log`
5. Открыть HTML отчет: `npm run test:e2e:report`

Подробнее см. [e2e/README.md](./e2e/README.md)

### 5. Проверка перед коммитом

**ОБЯЗАТЕЛЬНЫЙ чеклист перед каждым коммитом:**

```bash
# 1. Запустить все unit-тесты
npm run test:run

# 2. Проверить покрытие
npm run coverage

# 3. Собрать проект
npm run build

# 4. Если были изменения в UI - запустить E2E
# Шаг 1: Запустить dev сервер (КРИТИЧНО!)
npm run dev  # в отдельном терминале, дождаться ✓ VITE ready

# Шаг 2: Запустить тесты
npm run test:e2e  # во втором терминале

# PowerShell: Для корректного вывода
$env:FORCE_COLOR=1; npx playwright test --reporter=list
# Или:
.\run-e2e-tests.ps1

# Анализ результатов
type test-output.log         # логи выполнения
npm run test:e2e:report      # HTML отчет
dir test-results             # скриншоты и видео
```

**Все должно быть зеленым перед коммитом!**

### 6. Примеры тестирования разных сценариев

#### Тестирование функции с side-эффектами
```typescript
test('updateExpression изменяет состояние', () => {
  const state = { expression: 'x + 1' };
  updateExpression(state, 'x + 2');
  expect(state.expression).toBe('x + 2');
});
```

#### Тестирование асинхронного кода
```typescript
test('загрузка данных завершается успешно', async () => {
  const data = await loadData();
  expect(data).toBeDefined();
});
```

#### Тестирование исключений
```typescript
test('выбрасывает ошибку при невалидном вводе', () => {
  expect(() => parse('invalid')).toThrow('Parse error');
});
```

#### E2E тест взаимодействия
```typescript
test('пользователь может ввести выражение', async ({ page }) => {
  await page.goto('/expression-editor-modular.html');
  
  // Правильные селекторы для проекта:
  const expressionInput = page.locator('#expressionInput');
  await expressionInput.click();
  await expressionInput.fill('2 + 2');
  await page.locator('#buildBtn').click();
  
  const container = page.locator('#expressionContainer');
  await expect(container).toContainText('2 + 2');
});
```

### 7. Когда можно НЕ писать тесты

**Исключения (очень редкие случаи):**
- Чисто визуальные CSS изменения без логики
- Временные экспериментальные скрипты
- Прототипирование (но перед мержем в main - тесты обязательны!)

**ВО ВСЕХ ОСТАЛЬНЫХ СЛУЧАЯХ ТЕСТЫ ОБЯЗАТЕЛЬНЫ.**

### 8. Отладка падающих тестов

**Если тест упал:**

1. **Прочитать сообщение об ошибке** - часто там все написано
2. **Запустить только этот тест** - изолировать проблему
   ```bash
   npm test -- parser.test.ts -t "конкретный тест"
   ```
3. **Добавить console.log** - вывести промежуточные значения
4. **Использовать debugger** - поставить breakpoint
5. **Проверить assumptions** - возможно тест проверяет неправильное поведение

**Если E2E тест упал:**

1. **Прочитать сообщение об ошибке**
2. **Проверить типичные проблемы:**
   - `ERR_CONNECTION_REFUSED` → Запустите `npm run dev`
   - `toHaveTitle failed` → Заголовок "Преобразователь выражений"
   - Элемент не найден → Правильные ID: #expressionInput, #commandsPanel, #expressionContainer, #buildBtn, #clearBtn
3. **Запустить с видимым браузером:**
   ```bash
   npm run test:e2e:headed
   ```
4. **Использовать режим отладки:**
   ```bash
   npm run test:e2e:debug
   ```
5. **Просмотреть артефакты:**
   - Скриншоты в `test-results/`
   - Логи в `test-output.log`
   - HTML отчет: `npm run test:e2e:report`
6. **Проверить сервер:**
   ```bash
   curl http://localhost:8000/expression-editor-modular.html
   ```

### 9. Continuous Integration

**При работе с CI/CD:**
- Все тесты должны проходить на CI
- Не мержить PR если тесты красные
- Если тест нестабильный (flaky) - исправить или удалить
- Coverage должен быть не ниже установленного порога

### 10. Культура тестирования

**Правила команды:**
- Код без тестов = незавершенный код
- Failing тест важнее чем его отсутствие
- Тесты - это документация того, как код должен работать
- Хороший тест проваливается когда код сломан, и проходит когда код работает
- Тесты должны быть простыми и понятными
- Один тест = одна проверка (один expect в идеале)

## Дополнительные правила

1. При работе с веб-приложениями использовать современные фреймворки по умолчанию (React, Vue, Angular)
2. При отсутствии специальных указаний использовать стандартные практики разработки
3. Все создаваемые диаграммы должны быть без стилей и оформления
4. При генерации кода обеспечивать его немедленную работоспособность
